# Caddyfile for MTÃœ Kaiu Kodukant Website
# Development and testing configuration

# Use environment variable for domain, fallback to localhost
{$DOMAIN_NAME:localhost} {
	# Enable file server with browse
	root * /usr/share/caddy

	# URL rewriting for clean URLs (pages/ directory)
	@root {
		path /
	}
	rewrite @root /pages/index.html

	@pages {
		path /about
		path /events
		path /gallery
		path /membership
		path /contact
	}
	rewrite @pages /pages{path}.html

	file_server

	# Enable compression
	encode gzip zstd

	# Security headers
	header {
		# Basic security headers
		X-Content-Type-Options "nosniff"
		X-Frame-Options "SAMEORIGIN"
		X-XSS-Protection "1; mode=block"
		Referrer-Policy "strict-origin-when-cross-origin"
		
		# CSP allowing Google services and reCAPTCHA
		Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.google.com https://www.gstatic.com https://cdn.tailwindcss.com https://cdn.jsdelivr.net https://script.google.com https://script.googleusercontent.com https://www.recaptcha.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net; font-src 'self' data: https://fonts.gstatic.com; img-src 'self' data: https: blob:; connect-src 'self' https://script.google.com https://script.googleusercontent.com https://www.google.com https://www.gstatic.com https://www.recaptcha.net; frame-src 'self' https://www.google.com https://www.recaptcha.net https://script.google.com https://script.googleusercontent.com"
		
		# Remove server header
		-Server
	}

	# CORS headers for API requests
	@api {
		path /api/*
	}
	header @api {
		Access-Control-Allow-Origin "*"
		Access-Control-Allow-Methods "GET, POST, OPTIONS"
		Access-Control-Allow-Headers "Content-Type, Authorization"
	}

	# Cache static assets
	@static {
		path *.css *.js *.jpg *.jpeg *.png *.gif *.svg *.woff *.woff2 *.ttf *.eot
	}
	header @static {
		Cache-Control "public, max-age=604800, immutable"
	}

	# Cache HTML files for shorter period
	@html_cache {
		path *.html
	}
	header @html_cache {
		Cache-Control "public, max-age=3600"
	}

	# Handle SPA routing (if needed in future)
	# try_files {path} /index.html

	# Enable access log
	log {
		output file /var/log/caddy/access.log
		format console
		level INFO
	}

	# Custom error pages (optional)
	handle_errors {
		@404 {
			expression {http.error.status_code} == 404
		}
		respond @404 "Lehte ei leitud - Page not found" 404
	}
}

# Redirect www to non-www (if using custom domain)
www.{$DOMAIN_NAME:localhost} {
	redir https://{$DOMAIN_NAME:localhost}{uri} permanent
}

# Health check endpoint
:8080 {
	respond /health "OK" 200
}