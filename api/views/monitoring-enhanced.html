<!DOCTYPE html>
<html lang="et">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitooring - MT√ú Kaiu Kodukant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/admin/assets/admin.css">
    <style>
        .status-success { color: #10b981; }
        .status-warning { color: #f59e0b; }
        .status-error { color: #ef4444; }
        .timeline-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        .timeline-success { background-color: #10b981; }
        .timeline-warning { background-color: #f59e0b; }
        .timeline-error { background-color: #ef4444; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-semibold text-gray-800">S3 Sync Monitooring</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/admin" class="text-gray-600 hover:text-gray-900">Tagasi</a>
                    <button onclick="logout()" class="text-red-600 hover:text-red-700 font-medium">
                        Logi v√§lja
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Current Status Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- Calendar Status -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-lg font-semibold">üìÖ Kalendri Sync</h3>
                    <span id="calendarStatusBadge" class="px-2 py-1 text-xs font-medium rounded-full">-</span>
                </div>

                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Viimane sync:</span>
                        <span id="calendarLastSync" class="font-mono text-sm">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">S√ºndmusi:</span>
                        <span id="calendarEvents">-</span>
                    </div>
                </div>

                <!-- Stats -->
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">24h statistika</h4>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div>
                            <span class="text-gray-500">√ïnnestumise %:</span>
                            <span id="calendarSuccessRate" class="font-medium ml-1">-</span>
                        </div>
                        <div>
                            <span class="text-gray-500">Sync sagedus:</span>
                            <span id="calendarInterval" class="font-medium ml-1">-</span>
                        </div>
                    </div>
                </div>

                <!-- Timeline -->
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">Viimased 10 synci</h4>
                    <div id="calendarTimeline" class="flex gap-1">
                        <!-- Timeline dots will be added here -->
                    </div>
                </div>
            </div>

            <!-- Gallery Status -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-lg font-semibold">üñºÔ∏è Galerii Sync</h3>
                    <span id="galleryStatusBadge" class="px-2 py-1 text-xs font-medium rounded-full">-</span>
                </div>

                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Viimane sync:</span>
                        <span id="galleryLastSync" class="font-mono text-sm">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Albumeid:</span>
                        <span id="galleryAlbums">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Fotosid:</span>
                        <span id="galleryPhotos">-</span>
                    </div>
                </div>

                <!-- Stats -->
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">24h statistika</h4>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div>
                            <span class="text-gray-500">√ïnnestumise %:</span>
                            <span id="gallerySuccessRate" class="font-medium ml-1">-</span>
                        </div>
                        <div>
                            <span class="text-gray-500">Sync sagedus:</span>
                            <span id="galleryInterval" class="font-medium ml-1">-</span>
                        </div>
                    </div>
                </div>

                <!-- Timeline -->
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">Viimased 10 synci</h4>
                    <div id="galleryTimeline" class="flex gap-1">
                        <!-- Timeline dots will be added here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed History -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">üìã Detailne Sync Ajalugu</h3>
                <div class="flex gap-2">
                    <select id="historyFilter" class="px-3 py-1 border rounded-lg text-sm">
                        <option value="all">K√µik</option>
                        <option value="calendar">Kalender</option>
                        <option value="gallery">Galerii</option>
                    </select>
                    <button onclick="refreshAll()" class="text-blue-600 hover:text-blue-700">
                        V√§rskenda
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Aeg</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">T√º√ºp</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Staatus</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Elemendid</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Allikas</th>
                        </tr>
                    </thead>
                    <tbody id="historyTable" class="bg-white divide-y divide-gray-200">
                        <!-- History will be loaded here -->
                    </tbody>
                </table>
                <div id="noHistory" class="hidden text-center py-4 text-gray-500">
                    Ajalugu puudub
                </div>
            </div>
        </div>
    </div>

    <script>
        let token = localStorage.getItem('adminToken') || getCookie('adminToken');
        let isLoading = false;

        async function loadMonitoringData() {
            if (isLoading) return;
            isLoading = true;

            try {
                const response = await fetch(`/api/v1/monitoring/status?t=${Date.now()}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Cache-Control': 'no-cache'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    updateStatus(data);
                    updateStats(data.stats);
                    updateTimelines(data.history);
                }

                // Load detailed history
                await loadHistory();
            } catch (error) {
                console.error('Error loading monitoring data:', error);
            } finally {
                isLoading = false;
            }
        }

        function updateStatus(data) {
            // Calendar status
            if (data.calendar) {
                const status = data.calendar.status;
                const badge = document.getElementById('calendarStatusBadge');
                badge.textContent = status === 'ok' ? '‚úÖ OK' :
                                   status === 'warning' ? '‚ö†Ô∏è Hoiatus' :
                                   status === 'error' ? '‚ùå Viga' : '‚ùì Teadmata';
                badge.className = `px-2 py-1 text-xs font-medium rounded-full ${
                    status === 'ok' ? 'bg-green-100 text-green-800' :
                    status === 'warning' ? 'bg-yellow-100 text-yellow-800' :
                    status === 'error' ? 'bg-red-100 text-red-800' :
                    'bg-gray-100 text-gray-800'
                }`;

                document.getElementById('calendarLastSync').textContent =
                    data.calendar.lastSync ? formatTime(data.calendar.lastSync) : 'Teadmata';
                document.getElementById('calendarEvents').textContent = data.calendar.eventsCount || 0;
            }

            // Gallery status
            if (data.gallery) {
                const status = data.gallery.status;
                const badge = document.getElementById('galleryStatusBadge');
                badge.textContent = status === 'ok' ? '‚úÖ OK' :
                                   status === 'warning' ? '‚ö†Ô∏è Hoiatus' :
                                   status === 'error' ? '‚ùå Viga' : '‚ùì Teadmata';
                badge.className = `px-2 py-1 text-xs font-medium rounded-full ${
                    status === 'ok' ? 'bg-green-100 text-green-800' :
                    status === 'warning' ? 'bg-yellow-100 text-yellow-800' :
                    status === 'error' ? 'bg-red-100 text-red-800' :
                    'bg-gray-100 text-gray-800'
                }`;

                document.getElementById('galleryLastSync').textContent =
                    data.gallery.lastSync ? formatTime(data.gallery.lastSync) : 'Teadmata';
                document.getElementById('galleryAlbums').textContent = data.gallery.albumsCount || 0;
                document.getElementById('galleryPhotos').textContent = data.gallery.photosCount || 0;
            }
        }

        function updateStats(stats) {
            if (stats?.calendar) {
                document.getElementById('calendarSuccessRate').textContent =
                    stats.calendar.successRate ? `${stats.calendar.successRate}%` : '-';
                document.getElementById('calendarInterval').textContent =
                    stats.calendar.averageInterval ? `~${stats.calendar.averageInterval} min` : '-';
            }

            if (stats?.gallery) {
                document.getElementById('gallerySuccessRate').textContent =
                    stats.gallery.successRate ? `${stats.gallery.successRate}%` : '-';
                document.getElementById('galleryInterval').textContent =
                    stats.gallery.averageInterval ? `~${stats.gallery.averageInterval} min` : '-';
            }
        }

        function updateTimelines(history) {
            // Calendar timeline
            if (history?.calendar) {
                const timeline = document.getElementById('calendarTimeline');
                timeline.innerHTML = history.calendar.slice(0, 10).reverse().map(entry => {
                    const status = entry.status || 'unknown';
                    const statusClass = status === 'success' ? 'timeline-success' :
                                      status === 'warning' ? 'timeline-warning' :
                                      status === 'error' ? 'timeline-error' :
                                      'bg-gray-300';
                    const title = `${formatTime(entry.timestamp)}\nStatus: ${status}${entry.error ? '\n' + entry.error : ''}`;
                    return `<span class="timeline-dot ${statusClass}" title="${title}"></span>`;
                }).join('');
            }

            // Gallery timeline
            if (history?.gallery) {
                const timeline = document.getElementById('galleryTimeline');
                timeline.innerHTML = history.gallery.slice(0, 10).reverse().map(entry => {
                    const status = entry.status || 'unknown';
                    const statusClass = status === 'success' ? 'timeline-success' :
                                      status === 'warning' ? 'timeline-warning' :
                                      status === 'error' ? 'timeline-error' :
                                      'bg-gray-300';
                    const title = `${formatTime(entry.timestamp)}\nStatus: ${status}${entry.error ? '\n' + entry.error : ''}`;
                    return `<span class="timeline-dot ${statusClass}" title="${title}"></span>`;
                }).join('');
            }
        }

        async function loadHistory() {
            const filter = document.getElementById('historyFilter').value;
            try {
                const response = await fetch(`/api/v1/monitoring/history?type=${filter}&limit=50&t=${Date.now()}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Cache-Control': 'no-cache'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    updateHistoryTable(data.history);
                }
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        function updateHistoryTable(history) {
            const tbody = document.getElementById('historyTable');
            const noHistory = document.getElementById('noHistory');

            // Combine all histories
            const allEntries = [];

            if (history.calendar) {
                history.calendar.forEach(entry => {
                    allEntries.push({ ...entry, type: 'calendar' });
                });
            }

            if (history.gallery) {
                history.gallery.forEach(entry => {
                    allEntries.push({ ...entry, type: 'gallery' });
                });
            }

            // Sort by timestamp
            allEntries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (allEntries.length === 0) {
                tbody.innerHTML = '';
                noHistory.classList.remove('hidden');
                return;
            }

            noHistory.classList.add('hidden');
            tbody.innerHTML = allEntries.slice(0, 50).map(entry => {
                const statusClass = entry.status === 'success' ? 'status-success' :
                                   entry.status === 'warning' ? 'status-warning' :
                                   entry.status === 'error' ? 'status-error' : '';
                const statusText = entry.status === 'success' ? '‚úÖ √ïnnestus' :
                                  entry.status === 'warning' ? '‚ö†Ô∏è Hoiatus' :
                                  entry.status === 'error' ? '‚ùå Eba√µnnestus' : '‚ùì Teadmata';

                const counts = entry.type === 'calendar'
                    ? `${entry.eventsCount || 0} s√ºndmust`
                    : `${entry.albumsCount || 0} albumit, ${entry.photosCount || 0} fotot`;

                return `
                    <tr>
                        <td class="px-4 py-2 text-sm">${formatTime(entry.timestamp)}</td>
                        <td class="px-4 py-2 text-sm">${entry.type === 'calendar' ? 'üìÖ Kalender' : 'üñºÔ∏è Galerii'}</td>
                        <td class="px-4 py-2 text-sm ${statusClass}">${statusText}</td>
                        <td class="px-4 py-2 text-sm">${counts}</td>
                        <td class="px-4 py-2 text-sm text-gray-600">${entry.source || 'monitor'}</td>
                    </tr>
                `;
            }).join('');
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) {
                return 'Just n√º√ºd';
            } else if (diff < 3600000) {
                const mins = Math.floor(diff / 60000);
                return `${mins} min tagasi`;
            } else if (diff < 86400000) {
                const hours = Math.floor(diff / 3600000);
                return `${hours}h tagasi`;
            } else {
                return date.toLocaleString('et-EE');
            }
        }

        function refreshAll() {
            loadMonitoringData();
        }

        function logout() {
            localStorage.removeItem('adminToken');
            document.cookie = 'adminToken=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT';
            window.location.href = '/admin/login';
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        // Filter change handler
        document.getElementById('historyFilter').addEventListener('change', loadHistory);

        // Load data on page load
        loadMonitoringData();

        // Auto-refresh every 30 seconds
        setInterval(loadMonitoringData, 30000);
    </script>
</body>
</html>