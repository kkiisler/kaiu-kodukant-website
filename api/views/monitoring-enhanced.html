<!DOCTYPE html>
<html lang="et">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitooring - MT√ú Kaiu Kodukant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/admin/assets/admin.css">
    <style>
        .status-success { color: #10b981; }
        .status-warning { color: #f59e0b; }
        .status-error { color: #ef4444; }
        .timeline-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        .timeline-success { background-color: #10b981; }
        .timeline-warning { background-color: #f59e0b; }
        .timeline-error { background-color: #ef4444; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-semibold text-gray-800">S√ºsteemi Monitooring</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/admin" class="text-gray-600 hover:text-gray-900">Tagasi</a>
                    <button onclick="logout()" class="text-red-600 hover:text-red-700 font-medium">
                        Logi v√§lja
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Current Status Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- Calendar Status -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-lg font-semibold">üìÖ Kalendri Sync</h3>
                    <span id="calendarStatusBadge" class="px-2 py-1 text-xs font-medium rounded-full">-</span>
                </div>

                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Viimane sync:</span>
                        <span id="calendarLastSync" class="font-mono text-sm">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">S√ºndmusi:</span>
                        <span id="calendarEvents">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">J√§rgmine sync:</span>
                        <span id="calendarNextSync" class="font-mono text-sm">-</span>
                    </div>
                </div>

                <!-- Manual Sync Button -->
                <div class="mt-4">
                    <button onclick="triggerCalendarSync()" id="calendarSyncBtn" class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                        üîÑ K√§ivita k√§sitsi sync
                    </button>
                </div>

                <!-- Stats -->
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">24h statistika</h4>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div>
                            <span class="text-gray-500">√ïnnestumise %:</span>
                            <span id="calendarSuccessRate" class="font-medium ml-1">-</span>
                        </div>
                        <div>
                            <span class="text-gray-500">Sync sagedus:</span>
                            <span id="calendarInterval" class="font-medium ml-1">-</span>
                        </div>
                    </div>
                </div>

                <!-- Timeline -->
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">Viimased 10 synci</h4>
                    <div id="calendarTimeline" class="flex gap-1">
                        <!-- Timeline dots will be added here -->
                    </div>
                </div>
            </div>

            <!-- Gallery Status -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-lg font-semibold">üñºÔ∏è Galerii Sync</h3>
                    <span id="galleryStatusBadge" class="px-2 py-1 text-xs font-medium rounded-full">-</span>
                </div>

                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Viimane sync:</span>
                        <span id="galleryLastSync" class="font-mono text-sm">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Albumeid:</span>
                        <span id="galleryAlbums">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Fotosid:</span>
                        <span id="galleryPhotos">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">J√§rgmine sync:</span>
                        <span id="galleryNextSync" class="font-mono text-sm">-</span>
                    </div>
                </div>

                <!-- Manual Sync Button -->
                <div class="mt-4">
                    <button onclick="triggerGallerySync()" id="gallerySyncBtn" class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                        üîÑ K√§ivita k√§sitsi sync
                    </button>
                </div>

                <!-- Stats -->
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">24h statistika</h4>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div>
                            <span class="text-gray-500">√ïnnestumise %:</span>
                            <span id="gallerySuccessRate" class="font-medium ml-1">-</span>
                        </div>
                        <div>
                            <span class="text-gray-500">Sync sagedus:</span>
                            <span id="galleryInterval" class="font-medium ml-1">-</span>
                        </div>
                    </div>
                </div>

                <!-- Timeline -->
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">Viimased 10 synci</h4>
                    <div id="galleryTimeline" class="flex gap-1">
                        <!-- Timeline dots will be added here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed History -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">üìã Detailne Sync Ajalugu</h3>
                <div class="flex gap-2">
                    <select id="historyFilter" class="px-3 py-1 border rounded-lg text-sm">
                        <option value="all">K√µik</option>
                        <option value="calendar">Kalender</option>
                        <option value="gallery">Galerii</option>
                    </select>
                    <button onclick="refreshAll()" class="text-blue-600 hover:text-blue-700">
                        V√§rskenda
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Aeg</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">T√º√ºp</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Staatus</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Elemendid</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Allikas</th>
                        </tr>
                    </thead>
                    <tbody id="historyTable" class="bg-white divide-y divide-gray-200">
                        <!-- History will be loaded here -->
                    </tbody>
                </table>
                <div id="noHistory" class="hidden text-center py-4 text-gray-500">
                    Ajalugu puudub
                </div>
            </div>
        </div>

        <!-- Weather Blurbs Section -->
        <div class="mt-8">
            <h2 class="text-xl font-semibold mb-4">üå§Ô∏è Ilmateated</h2>

            <!-- Weather Status Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Current Weather -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">Praegune ilmateade</h3>
                    <div id="currentWeatherBlurb" class="mb-4 p-4 bg-blue-50 rounded-lg">
                        <p class="text-gray-700">Laadimine...</p>
                    </div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Temperatuur:</span>
                            <span id="weatherTemp">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Tingimused:</span>
                            <span id="weatherConditions">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Tuul:</span>
                            <span id="weatherWind">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Loodud:</span>
                            <span id="weatherCreated">-</span>
                        </div>
                    </div>
                </div>

                <!-- Weather Stats -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">Statistika</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Teateid kokku:</span>
                            <span id="weatherTotalBlurbs">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Viimase 24h:</span>
                            <span id="weatherRecentBlurbs">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Keskmine temp (7p):</span>
                            <span id="weatherAvgTemp">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">J√§rgmine uuendus:</span>
                            <span id="weatherNextUpdate">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">OpenAI mudel:</span>
                            <span id="weatherModel" class="text-xs">-</span>
                        </div>
                    </div>
                    <div class="mt-4">
                        <button onclick="generateWeatherBlurb()" class="w-full bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
                            Genereeri uus teade
                        </button>
                    </div>
                </div>
            </div>

            <!-- Weather Sources Debug -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">üîç Ilmaandmete allikad (Debug)</h3>
                    <button onclick="loadWeatherSources()" class="text-sm bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded">
                        üîÑ V√§rskenda
                    </button>
                </div>

                <div id="weatherSourcesContent">
                    <p class="text-gray-500">Laadimine...</p>
                </div>
            </div>

            <!-- Weather History -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4">20 viimast ilmateadet</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Aeg</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Teade</th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Temp</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Ilm</th>
                            </tr>
                        </thead>
                        <tbody id="weatherHistoryTable" class="bg-white divide-y divide-gray-200">
                            <!-- Weather history will be loaded here -->
                        </tbody>
                    </table>
                    <div id="noWeatherHistory" class="hidden text-center py-4 text-gray-500">
                        Ilmateateid ei leitud
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let token = localStorage.getItem('adminToken') || getCookie('adminToken');
        let isLoading = false;

        async function loadMonitoringData() {
            if (isLoading) return;
            isLoading = true;

            try {
                // Load calendar and gallery status from new endpoints
                const [calendarResponse, galleryResponse, monitoringResponse] = await Promise.all([
                    fetch(`/api/v1/calendar/status?t=${Date.now()}`, {
                        headers: {
                            'Cache-Control': 'no-cache'
                        }
                    }),
                    fetch(`/api/v1/gallery/status?t=${Date.now()}`, {
                        headers: {
                            'Cache-Control': 'no-cache'
                        }
                    }),
                    fetch(`/api/v1/monitoring/status?t=${Date.now()}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Cache-Control': 'no-cache'
                        }
                    })
                ]);

                if (calendarResponse.ok) {
                    const calendarData = await calendarResponse.json();
                    updateCalendarStatus(calendarData.data);
                }

                if (galleryResponse.ok) {
                    const galleryData = await galleryResponse.json();
                    updateGalleryStatus(galleryData.data);
                }

                if (monitoringResponse.ok) {
                    const data = await monitoringResponse.json();
                    // Only update stats and timelines if they exist
                    if (data.stats) updateStats(data.stats);
                    if (data.history) updateTimelines(data.history);
                }

                // Load detailed history
                await loadHistory();

                // Load weather data
                await loadWeatherData();
            } catch (error) {
                console.error('Error loading monitoring data:', error);
            } finally {
                isLoading = false;
            }
        }

        function updateCalendarStatus(data) {
            if (!data) return;

            const status = data.isStale ? 'error' : (data.synced ? 'ok' : 'warning');
            const badge = document.getElementById('calendarStatusBadge');
            badge.textContent = status === 'ok' ? '‚úÖ OK' :
                               status === 'warning' ? '‚ö†Ô∏è Hoiatus' :
                               status === 'error' ? '‚ùå Viga' : '‚ùì Teadmata';
            badge.className = `px-2 py-1 text-xs font-medium rounded-full ${
                status === 'ok' ? 'bg-green-100 text-green-800' :
                status === 'warning' ? 'bg-yellow-100 text-yellow-800' :
                status === 'error' ? 'bg-red-100 text-red-800' :
                'bg-gray-100 text-gray-800'
            }`;

            document.getElementById('calendarLastSync').textContent =
                data.lastSync ? formatTime(data.lastSync) : 'Teadmata';
            document.getElementById('calendarEvents').textContent = data.eventCount || 0;

            // Calculate next sync time
            if (data.lastSync) {
                const lastSyncTime = new Date(data.lastSync);
                const nextSyncTime = new Date(lastSyncTime.getTime() + 15 * 60 * 1000); // 15 minutes interval
                const now = new Date();
                if (nextSyncTime > now) {
                    const diff = nextSyncTime - now;
                    const minutes = Math.floor(diff / 60000);
                    document.getElementById('calendarNextSync').textContent = `${minutes} min p√§rast`;
                } else {
                    document.getElementById('calendarNextSync').textContent = 'Kohe';
                }
            } else {
                document.getElementById('calendarNextSync').textContent = '-';
            }
        }

        function updateGalleryStatus(data) {
            if (!data) return;

            // Map idle status to ok for display
            const displayStatus = data.status === 'idle' ? 'ok' : data.status;
            const badge = document.getElementById('galleryStatusBadge');
            badge.textContent = displayStatus === 'ok' ? '‚úÖ OK' :
                               displayStatus === 'syncing' ? 'üîÑ S√ºnkroonimine' :
                               displayStatus === 'error' ? '‚ùå Viga' : '‚ùì Teadmata';
            badge.className = `px-2 py-1 text-xs font-medium rounded-full ${
                displayStatus === 'ok' ? 'bg-green-100 text-green-800' :
                displayStatus === 'syncing' ? 'bg-blue-100 text-blue-800' :
                displayStatus === 'error' ? 'bg-red-100 text-red-800' :
                'bg-gray-100 text-gray-800'
            }`;

            document.getElementById('galleryLastSync').textContent =
                data.lastSync ? formatTime(data.lastSync) : 'Teadmata';
            document.getElementById('galleryAlbums').textContent = data.totalAlbums || 0;
            document.getElementById('galleryPhotos').textContent = data.totalPhotos || 0;

            // Calculate next sync time
            if (data.lastSync) {
                const lastSyncTime = new Date(data.lastSync);
                const nextSyncTime = new Date(lastSyncTime.getTime() + 60 * 60 * 1000); // 1 hour interval
                const now = new Date();
                if (nextSyncTime > now) {
                    const diff = nextSyncTime - now;
                    const minutes = Math.floor(diff / 60000);
                    const hours = Math.floor(minutes / 60);
                    const remainingMinutes = minutes % 60;
                    if (hours > 0) {
                        document.getElementById('galleryNextSync').textContent = `${hours}h ${remainingMinutes}m p√§rast`;
                    } else {
                        document.getElementById('galleryNextSync').textContent = `${remainingMinutes} min p√§rast`;
                    }
                } else {
                    document.getElementById('galleryNextSync').textContent = 'Kohe';
                }
            } else {
                document.getElementById('galleryNextSync').textContent = '-';
            }
        }

        async function triggerCalendarSync() {
            const button = document.getElementById('calendarSyncBtn');
            button.disabled = true;
            button.textContent = '‚è≥ S√ºnkroonimine...';

            try {
                const response = await fetch('/api/v1/calendar/sync', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    alert('Kalendri sync √µnnestus!');
                    await loadMonitoringData();
                } else {
                    alert('Viga: ' + (data.error || 'Sync eba√µnnestus'));
                }
            } catch (error) {
                console.error('Error triggering calendar sync:', error);
                alert('Viga kalendri s√ºnkroonimisel');
            } finally {
                button.disabled = false;
                button.textContent = 'üîÑ K√§ivita k√§sitsi sync';
            }
        }

        async function triggerGallerySync() {
            const button = document.getElementById('gallerySyncBtn');
            button.disabled = true;
            button.textContent = '‚è≥ S√ºnkroonimine...';

            try {
                const response = await fetch('/api/v1/gallery/sync', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    alert('Galerii sync √µnnestus!');
                    await loadMonitoringData();
                } else {
                    alert('Viga: ' + (data.error || 'Sync eba√µnnestus'));
                }
            } catch (error) {
                console.error('Error triggering gallery sync:', error);
                alert('Viga galerii s√ºnkroonimisel');
            } finally {
                button.disabled = false;
                button.textContent = 'üîÑ K√§ivita k√§sitsi sync';
            }
        }

        function updateStats(stats) {
            if (stats?.calendar) {
                document.getElementById('calendarSuccessRate').textContent =
                    stats.calendar.successRate ? `${stats.calendar.successRate}%` : '-';
                document.getElementById('calendarInterval').textContent =
                    stats.calendar.averageInterval ? `~${stats.calendar.averageInterval} min` : '-';
            }

            if (stats?.gallery) {
                document.getElementById('gallerySuccessRate').textContent =
                    stats.gallery.successRate ? `${stats.gallery.successRate}%` : '-';
                document.getElementById('galleryInterval').textContent =
                    stats.gallery.averageInterval ? `~${stats.gallery.averageInterval} min` : '-';
            }
        }

        function updateTimelines(history) {
            // Calendar timeline
            if (history?.calendar) {
                const timeline = document.getElementById('calendarTimeline');
                timeline.innerHTML = history.calendar.slice(0, 10).reverse().map(entry => {
                    const status = entry.status || 'unknown';
                    const statusClass = status === 'success' ? 'timeline-success' :
                                      status === 'warning' ? 'timeline-warning' :
                                      status === 'error' ? 'timeline-error' :
                                      'bg-gray-300';
                    const title = `${formatTime(entry.timestamp)}\nStatus: ${status}${entry.error ? '\n' + entry.error : ''}`;
                    return `<span class="timeline-dot ${statusClass}" title="${title}"></span>`;
                }).join('');
            }

            // Gallery timeline
            if (history?.gallery) {
                const timeline = document.getElementById('galleryTimeline');
                timeline.innerHTML = history.gallery.slice(0, 10).reverse().map(entry => {
                    const status = entry.status || 'unknown';
                    const statusClass = status === 'success' ? 'timeline-success' :
                                      status === 'warning' ? 'timeline-warning' :
                                      status === 'error' ? 'timeline-error' :
                                      'bg-gray-300';
                    const title = `${formatTime(entry.timestamp)}\nStatus: ${status}${entry.error ? '\n' + entry.error : ''}`;
                    return `<span class="timeline-dot ${statusClass}" title="${title}"></span>`;
                }).join('');
            }
        }

        async function loadHistory() {
            const filter = document.getElementById('historyFilter').value;
            try {
                const response = await fetch(`/api/v1/monitoring/history?type=${filter}&limit=50&t=${Date.now()}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Cache-Control': 'no-cache'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    updateHistoryTable(data.history);
                }
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        function updateHistoryTable(history) {
            const tbody = document.getElementById('historyTable');
            const noHistory = document.getElementById('noHistory');

            // Combine all histories
            const allEntries = [];

            if (history.calendar) {
                history.calendar.forEach(entry => {
                    allEntries.push({ ...entry, type: 'calendar' });
                });
            }

            if (history.gallery) {
                history.gallery.forEach(entry => {
                    allEntries.push({ ...entry, type: 'gallery' });
                });
            }

            // Sort by timestamp
            allEntries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (allEntries.length === 0) {
                tbody.innerHTML = '';
                noHistory.classList.remove('hidden');
                return;
            }

            noHistory.classList.add('hidden');
            tbody.innerHTML = allEntries.slice(0, 50).map(entry => {
                const statusClass = entry.status === 'success' ? 'status-success' :
                                   entry.status === 'warning' ? 'status-warning' :
                                   entry.status === 'error' ? 'status-error' : '';
                const statusText = entry.status === 'success' ? '‚úÖ √ïnnestus' :
                                  entry.status === 'warning' ? '‚ö†Ô∏è Hoiatus' :
                                  entry.status === 'error' ? '‚ùå Eba√µnnestus' : '‚ùì Teadmata';

                const counts = entry.type === 'calendar'
                    ? `${entry.eventsCount || 0} s√ºndmust`
                    : `${entry.albumsCount || 0} albumit, ${entry.photosCount || 0} fotot`;

                return `
                    <tr>
                        <td class="px-4 py-2 text-sm">${formatTime(entry.timestamp)}</td>
                        <td class="px-4 py-2 text-sm">${entry.type === 'calendar' ? 'üìÖ Kalender' : 'üñºÔ∏è Galerii'}</td>
                        <td class="px-4 py-2 text-sm ${statusClass}">${statusText}</td>
                        <td class="px-4 py-2 text-sm">${counts}</td>
                        <td class="px-4 py-2 text-sm text-gray-600">${entry.source || 'monitor'}</td>
                    </tr>
                `;
            }).join('');
        }

        function formatTime(timestamp) {
            // Parse timestamp as UTC by appending 'Z' if not present
            const utcTimestamp = timestamp.includes('Z') ? timestamp : timestamp + 'Z';
            const date = new Date(utcTimestamp);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) {
                return 'Just n√º√ºd';
            } else if (diff < 3600000) {
                const mins = Math.floor(diff / 60000);
                return `${mins} min tagasi`;
            } else if (diff < 86400000) {
                const hours = Math.floor(diff / 3600000);
                return `${hours}h tagasi`;
            } else {
                return date.toLocaleString('et-EE');
            }
        }

        function refreshAll() {
            loadMonitoringData();
        }

        // Weather monitoring functions
        async function loadWeatherData() {
            try {
                const response = await fetch(`/api/v1/monitoring/weather?t=${Date.now()}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Cache-Control': 'no-cache'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data) {
                        updateWeatherDisplay(data.data);
                    }
                } else {
                    console.error('Failed to load weather data:', response.status);
                }
            } catch (error) {
                console.error('Error loading weather data:', error);
            }
        }

        function updateWeatherDisplay(data) {
            // Update latest blurb
            if (data.latestBlurb) {
                document.getElementById('currentWeatherBlurb').innerHTML = `
                    <p class="text-gray-700 leading-relaxed">
                        <span class="text-2xl mr-2">${data.latestBlurb.icon}</span>
                        ${data.latestBlurb.text}
                    </p>
                `;
                document.getElementById('weatherTemp').textContent = data.latestBlurb.temperature ? `${data.latestBlurb.temperature}¬∞C` : '-';
                document.getElementById('weatherConditions').textContent = data.latestBlurb.conditions || '-';
                document.getElementById('weatherWind').textContent =
                    data.latestBlurb.windSpeed ? `${data.latestBlurb.windSpeed} m/s ${data.latestBlurb.windDirection || ''}` : '-';
                document.getElementById('weatherCreated').textContent =
                    data.latestBlurb.createdAt ? formatTime(data.latestBlurb.createdAt) : '-';
            } else {
                document.getElementById('currentWeatherBlurb').innerHTML = `
                    <p class="text-gray-500">Ilmateadet pole veel genereeritud</p>
                `;
            }

            // Update statistics
            if (data.statistics) {
                document.getElementById('weatherTotalBlurbs').textContent = data.statistics.totalBlurbs || 0;
                document.getElementById('weatherRecentBlurbs').textContent = data.statistics.recentBlurbs || 0;
                document.getElementById('weatherAvgTemp').textContent =
                    data.statistics.avgTemperature ? `${data.statistics.avgTemperature.toFixed(1)}¬∞C` : '-';
            }

            // Update next update time
            if (data.nextUpdate) {
                document.getElementById('weatherNextUpdate').textContent = data.nextUpdate.display || '-';
            }

            // Update config
            if (data.config) {
                document.getElementById('weatherModel').textContent =
                    data.config.openAiConfigured ? data.config.model : 'Pole konfigureeritud';
            }

            // Update history table
            if (data.blurbHistory && data.blurbHistory.length > 0) {
                const tbody = document.getElementById('weatherHistoryTable');
                const noHistory = document.getElementById('noWeatherHistory');

                noHistory.classList.add('hidden');
                tbody.innerHTML = data.blurbHistory.map(blurb => `
                    <tr>
                        <td class="px-4 py-2 text-sm whitespace-nowrap">
                            ${formatTime(blurb.createdAt)}
                        </td>
                        <td class="px-4 py-2 text-sm">
                            <span class="mr-1">${blurb.icon}</span>
                            ${blurb.text.length > 100 ? blurb.text.substring(0, 100) + '...' : blurb.text}
                        </td>
                        <td class="px-4 py-2 text-sm text-center">
                            ${blurb.temperature ? `${blurb.temperature}¬∞C` : '-'}
                        </td>
                        <td class="px-4 py-2 text-sm">
                            ${blurb.conditions || '-'}
                        </td>
                    </tr>
                `).join('');
            } else {
                document.getElementById('weatherHistoryTable').innerHTML = '';
                document.getElementById('noWeatherHistory').classList.remove('hidden');
            }
        }

        async function generateWeatherBlurb() {
            if (!confirm('Kas soovid genereerida uue ilmateate?')) {
                return;
            }

            const button = event.target;
            button.disabled = true;
            button.textContent = 'Genereerimine...';

            try {
                const response = await fetch('/api/v1/weather/generate', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    alert('Uus ilmateade genereeritud!');
                    await loadWeatherData();
                } else {
                    alert('Viga: ' + (data.error || 'Teate genereerimine eba√µnnestus'));
                }
            } catch (error) {
                console.error('Error generating weather blurb:', error);
                alert('Viga teate genereerimisel');
            } finally {
                button.disabled = false;
                button.textContent = 'Genereeri uus teade';
            }
        }

        async function loadWeatherSources() {
            const container = document.getElementById('weatherSourcesContent');
            container.innerHTML = '<p class="text-gray-500">Laadimine...</p>';

            try {
                const response = await fetch(`/api/v1/weather/sources?t=${Date.now()}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Cache-Control': 'no-cache'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                if (data.success) {
                    displayWeatherSources(data.data);
                } else {
                    container.innerHTML = '<p class="text-red-500">Viga andmete laadimisel</p>';
                }
            } catch (error) {
                console.error('Error loading weather sources:', error);
                container.innerHTML = `<p class="text-red-500">Viga: ${error.message}</p>`;
            }
        }

        function displayWeatherSources(data) {
            const container = document.getElementById('weatherSourcesContent');

            // Build the HTML
            let html = `
                <!-- Source Availability -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="p-4 rounded-lg ${data.sources.estonian.available ? 'bg-green-50' : 'bg-red-50'}">
                        <div class="flex items-center justify-between">
                            <span class="font-medium">Ilmateenistus</span>
                            <span class="${data.sources.estonian.available ? 'text-green-600' : 'text-red-600'}">
                                ${data.sources.estonian.available ? '‚úì √úhendatud' : '‚úó √úhenduseta'}
                            </span>
                        </div>
                    </div>
                    <div class="p-4 rounded-lg ${data.sources.openMeteo.available ? 'bg-green-50' : 'bg-red-50'}">
                        <div class="flex items-center justify-between">
                            <span class="font-medium">Open-Meteo</span>
                            <span class="${data.sources.openMeteo.available ? 'text-green-600' : 'text-red-600'}">
                                ${data.sources.openMeteo.available ? '‚úì √úhendatud' : '‚úó √úhenduseta'}
                            </span>
                        </div>
                    </div>
                    <div class="p-4 rounded-lg bg-blue-50">
                        <div class="font-medium">Agregeeritud andmed</div>
                        <div class="text-sm text-gray-600 mt-1">
                            Allikas: ${data.aggregated.raw.source}
                        </div>
                    </div>
                </div>
            `;

            // Comparison metrics
            if (data.comparison) {
                const score = data.comparison.agreementScore;
                const scoreColor = score >= 90 ? 'text-green-600' : score >= 70 ? 'text-yellow-600' : 'text-red-600';

                html += `
                    <div class="mb-6">
                        <h4 class="font-medium mb-3">Allikate v√µrdlus</h4>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="flex justify-between items-center mb-4">
                                <span class="text-gray-700">Kokkulangevuse skoor:</span>
                                <span class="text-2xl font-bold ${scoreColor}">${score}%</span>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                                <div>
                                    <div class="text-gray-600 mb-1">Temperatuur</div>
                                    <div class="font-mono">
                                        ET: ${data.comparison.current.temperature.estonian}¬∞C<br>
                                        OM: ${data.comparison.current.temperature.openMeteo}¬∞C<br>
                                        Erinevus: ${data.comparison.current.temperature.difference}¬∞C
                                    </div>
                                </div>
                                <div>
                                    <div class="text-gray-600 mb-1">Tuule kiirus</div>
                                    <div class="font-mono">
                                        ET: ${data.comparison.current.windSpeed.estonian} m/s<br>
                                        OM: ${data.comparison.current.windSpeed.openMeteo} m/s<br>
                                        Erinevus: ${data.comparison.current.windSpeed.difference} m/s
                                    </div>
                                </div>
                                <div>
                                    <div class="text-gray-600 mb-1">Sademed (24h)</div>
                                    <div class="font-mono">
                                        ET: ${data.comparison.summary.totalPrecipitation.estonian} mm<br>
                                        OM: ${data.comparison.summary.totalPrecipitation.openMeteo} mm<br>
                                        Erinevus: ${data.comparison.summary.totalPrecipitation.difference} mm
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Alerts
            if (data.alerts && data.alerts.length > 0) {
                html += '<div class="mb-6"><h4 class="font-medium mb-3">‚ö†Ô∏è Hoiatused</h4><div class="space-y-2">';
                data.alerts.forEach(alert => {
                    const bgColor = alert.severity === 'warning' ? 'bg-yellow-50' : 'bg-blue-50';
                    const textColor = alert.severity === 'warning' ? 'text-yellow-800' : 'text-blue-800';
                    html += `
                        <div class="${bgColor} ${textColor} p-3 rounded-lg text-sm">
                            <span class="font-medium">${alert.type}:</span> ${alert.message}
                        </div>
                    `;
                });
                html += '</div></div>';
            }

            // Weights
            html += `
                <div class="mb-6">
                    <h4 class="font-medium mb-3">Kaalude konfiguratsioon</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="text-sm text-gray-600 mb-2">Hetke tingimused</div>
                            <div class="space-y-1 text-sm">
                                <div class="flex justify-between">
                                    <span>Open-Meteo:</span>
                                    <span class="font-mono">${data.weights.current.openMeteo}%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Ilmateenistus:</span>
                                    <span class="font-mono">${data.weights.current.estonian}%</span>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="text-sm text-gray-600 mb-2">24h Prognoos</div>
                            <div class="space-y-1 text-sm">
                                <div class="flex justify-between">
                                    <span>Open-Meteo:</span>
                                    <span class="font-mono">${data.weights.forecast.openMeteo}%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Ilmateenistus:</span>
                                    <span class="font-mono">${data.weights.forecast.estonian}%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Aggregated current data
            if (data.aggregated && data.aggregated.formatted && data.aggregated.formatted.current) {
                const curr = data.aggregated.formatted.current;
                html += `
                    <div>
                        <h4 class="font-medium mb-3">Agregeeritud hetkeandmed (AI-le sisendina)</h4>
                        <div class="bg-blue-50 rounded-lg p-4">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                <div>
                                    <div class="text-gray-600">Temperatuur</div>
                                    <div class="font-mono text-lg">${curr.temperature}¬∞C</div>
                                </div>
                                ${curr.apparentTemperature ? `
                                <div>
                                    <div class="text-gray-600">Tundub nagu</div>
                                    <div class="font-mono text-lg">${curr.apparentTemperature}¬∞C</div>
                                </div>
                                ` : ''}
                                ${curr.cloudCover !== undefined && curr.cloudCover !== null ? `
                                <div>
                                    <div class="text-gray-600">Pilvisus</div>
                                    <div class="font-mono text-lg">${curr.cloudCover}%</div>
                                </div>
                                ` : ''}
                                ${curr.humidity !== undefined && curr.humidity !== null ? `
                                <div>
                                    <div class="text-gray-600">Niiskus</div>
                                    <div class="font-mono text-lg">${curr.humidity}%</div>
                                </div>
                                ` : ''}
                                <div>
                                    <div class="text-gray-600">Tuul</div>
                                    <div class="font-mono text-lg">${curr.windSpeed} m/s</div>
                                </div>
                                <div>
                                    <div class="text-gray-600">Sademed</div>
                                    <div class="font-mono text-lg">${curr.precipitation} mm</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function logout() {
            localStorage.removeItem('adminToken');
            document.cookie = 'adminToken=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT';
            window.location.href = '/admin/login';
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        // Filter change handler
        document.getElementById('historyFilter').addEventListener('change', loadHistory);

        // Load data on page load
        loadMonitoringData();
        loadWeatherSources();

        // Auto-refresh every 30 seconds
        setInterval(loadMonitoringData, 30000);
    </script>
</body>
</html>