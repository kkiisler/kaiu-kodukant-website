<!DOCTYPE html>
<html lang="et">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitooring - MT√ú Kaiu Kodukant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/admin/assets/admin.css">
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-semibold text-gray-800">S√ºsteemi Monitooring</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/admin" class="text-gray-600 hover:text-gray-900">Tagasi</a>
                    <button onclick="logout()" class="text-red-600 hover:text-red-700 font-medium">
                        Logi v√§lja
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- S3 Sync Status -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- Calendar Sync Status -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4">üìÖ Kalendri Sync</h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Staatus:</span>
                        <span id="calendarStatus" class="font-medium">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Viimane sync:</span>
                        <span id="calendarLastSync" class="font-mono text-sm">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Vanus:</span>
                        <span id="calendarStaleness">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">S√ºndmusi:</span>
                        <span id="calendarEvents">-</span>
                    </div>
                </div>
            </div>

            <!-- Gallery Sync Status -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4">üñºÔ∏è Galerii Sync</h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Staatus:</span>
                        <span id="galleryStatus" class="font-medium">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Viimane sync:</span>
                        <span id="galleryLastSync" class="font-mono text-sm">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Vanus:</span>
                        <span id="galleryStaleness">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Albumeid:</span>
                        <span id="galleryAlbums">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Fotosid:</span>
                        <span id="galleryPhotos">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- S3 Configuration -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h3 class="text-lg font-semibold mb-4">‚öôÔ∏è S3 Konfiguratsioon</h3>
            <div class="space-y-2">
                <div class="flex">
                    <span class="text-gray-600 w-32">Endpoint:</span>
                    <span id="s3Endpoint" class="font-mono text-sm">-</span>
                </div>
                <div class="flex">
                    <span class="text-gray-600 w-32">Bucket:</span>
                    <span id="s3Bucket" class="font-mono text-sm">-</span>
                </div>
            </div>
        </div>

        <!-- Weather Blurbs Section -->
        <div class="mb-8">
            <h2 class="text-xl font-semibold mb-4">üå§Ô∏è Ilmateated</h2>

            <!-- Weather Status -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Current Weather -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">Praegune ilmateade</h3>
                    <div id="currentWeatherBlurb" class="mb-4 p-4 bg-blue-50 rounded-lg">
                        <p class="text-gray-700">Laadimine...</p>
                    </div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Temperatuur:</span>
                            <span id="weatherTemp">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Tingimused:</span>
                            <span id="weatherConditions">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Tuul:</span>
                            <span id="weatherWind">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Loodud:</span>
                            <span id="weatherCreated">-</span>
                        </div>
                    </div>
                </div>

                <!-- Weather Stats -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">Statistika</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Teateid kokku:</span>
                            <span id="weatherTotalBlurbs">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Viimase 24h:</span>
                            <span id="weatherRecentBlurbs">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Keskmine temp (7p):</span>
                            <span id="weatherAvgTemp">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">J√§rgmine uuendus:</span>
                            <span id="weatherNextUpdate">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">OpenAI mudel:</span>
                            <span id="weatherModel" class="text-xs">-</span>
                        </div>
                    </div>
                    <div class="mt-4">
                        <button onclick="generateWeatherBlurb()" class="w-full bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
                            Genereeri uus teade
                        </button>
                    </div>
                </div>
            </div>

            <!-- Weather History -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4">20 viimast ilmateadet</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Aeg</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Teade</th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Temp</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Ilm</th>
                            </tr>
                        </thead>
                        <tbody id="weatherHistoryTable" class="bg-white divide-y divide-gray-200">
                            <!-- Weather history will be loaded here -->
                        </tbody>
                    </table>
                    <div id="noWeatherHistory" class="hidden text-center py-4 text-gray-500">
                        Ilmateateid ei leitud
                    </div>
                </div>
            </div>
        </div>

        <!-- Sync Logs -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">üìã Viimased Sync Logid</h3>
                <button onclick="refreshLogs()" class="text-blue-600 hover:text-blue-700">
                    V√§rskenda
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Aeg</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">T√º√ºp</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Staatus</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Detailid</th>
                        </tr>
                    </thead>
                    <tbody id="logsTable" class="bg-white divide-y divide-gray-200">
                        <!-- Logs will be loaded here -->
                    </tbody>
                </table>
                <div id="noLogs" class="hidden text-center py-4 text-gray-500">
                    Logisid ei leitud
                </div>
            </div>
        </div>

        <!-- Refresh Button -->
        <div class="mt-8 text-center">
            <button onclick="refreshStatus()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                V√§rskenda k√µik
            </button>
        </div>
    </div>

    <script>
        let token = localStorage.getItem('adminToken') || getCookie('adminToken');
        let isLoading = false;  // Prevent concurrent loads

        async function loadMonitoringData() {
            // Prevent concurrent loads
            if (isLoading) {
                console.log('Already loading monitoring data, skipping concurrent request');
                return;
            }

            isLoading = true;

            try {
                // Load sync status (with cache bypass)
                const statusResponse = await fetch(`/api/v1/monitoring/status?t=${Date.now()}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Cache-Control': 'no-cache'
                    }
                });

                let statusData = null;
                if (statusResponse.ok) {
                    try {
                        statusData = await statusResponse.json();
                        if (statusData) {
                            updateSyncStatus(statusData);
                        }
                    } catch (jsonError) {
                        console.error('Failed to parse status response:', jsonError);
                    }
                } else {
                    console.error('Failed to load status:', statusResponse.status);
                }

                // Load logs separately with its own response object
                const logsResponse = await fetch(`/api/v1/monitoring/logs?t=${Date.now()}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Cache-Control': 'no-cache'
                    }
                });

                let logsData = null;
                if (logsResponse.ok) {
                    try {
                        logsData = await logsResponse.json();
                        if (logsData && logsData.logs) {
                            updateLogs(logsData.logs);
                        }
                    } catch (jsonError) {
                        console.error('Failed to parse logs response:', jsonError);
                    }
                } else {
                    console.error('Failed to load logs:', logsResponse.status);
                }

                // Load weather data
                await loadWeatherData();
            } catch (error) {
                console.error('Error loading monitoring data:', error);
                console.error('Error stack:', error.stack);
            } finally {
                isLoading = false;
            }
        }

        function updateSyncStatus(data) {
            // Calendar status
            if (data.calendar) {
                updateStatusElement('calendarStatus', data.calendar.status);
                document.getElementById('calendarLastSync').textContent =
                    data.calendar.lastSync ? new Date(data.calendar.lastSync).toLocaleString('et-EE') : 'Teadmata';
                document.getElementById('calendarStaleness').textContent =
                    data.calendar.staleness ? `${data.calendar.staleness} minutit` : '-';
                document.getElementById('calendarEvents').textContent = data.calendar.eventsCount || 0;
            }

            // Gallery status
            if (data.gallery) {
                updateStatusElement('galleryStatus', data.gallery.status);
                document.getElementById('galleryLastSync').textContent =
                    data.gallery.lastSync ? new Date(data.gallery.lastSync).toLocaleString('et-EE') : 'Teadmata';
                document.getElementById('galleryStaleness').textContent =
                    data.gallery.staleness ? `${data.gallery.staleness} minutit` : '-';
                document.getElementById('galleryAlbums').textContent = data.gallery.albumsCount || 0;
                document.getElementById('galleryPhotos').textContent = data.gallery.photosCount || 0;
            }

            // S3 config
            if (data.s3Storage) {
                document.getElementById('s3Endpoint').textContent = data.s3Storage.endpoint || '-';
                document.getElementById('s3Bucket').textContent = data.s3Storage.bucket || '-';
            }
        }

        function updateStatusElement(elementId, status) {
            const element = document.getElementById(elementId);
            element.textContent = status === 'ok' ? '‚úÖ OK' :
                                 status === 'warning' ? '‚ö†Ô∏è Hoiatus' :
                                 status === 'error' ? '‚ùå Viga' : '‚ùì Teadmata';

            element.className = status === 'ok' ? 'font-medium text-green-600' :
                               status === 'warning' ? 'font-medium text-yellow-600' :
                               status === 'error' ? 'font-medium text-red-600' :
                               'font-medium text-gray-500';
        }

        function updateLogs(logs) {
            const tbody = document.getElementById('logsTable');
            const noLogs = document.getElementById('noLogs');

            if (logs.length === 0) {
                tbody.innerHTML = '';
                noLogs.classList.remove('hidden');
                return;
            }

            noLogs.classList.add('hidden');
            tbody.innerHTML = logs.map(log => `
                <tr>
                    <td class="px-4 py-2 text-sm">${new Date(log.timestamp || log.syncTime).toLocaleString('et-EE')}</td>
                    <td class="px-4 py-2 text-sm">${log.type === 'calendar' ? 'üìÖ Kalender' : 'üñºÔ∏è Galerii'}</td>
                    <td class="px-4 py-2 text-sm">${log.success ? '‚úÖ √ïnnestus' : '‚ùå Eba√µnnestus'}</td>
                    <td class="px-4 py-2 text-sm text-gray-600">${log.error || log.message || '-'}</td>
                </tr>
            `).join('');
        }

        function refreshStatus() {
            loadMonitoringData();
        }

        function refreshLogs() {
            loadMonitoringData();
        }

        // Weather monitoring functions
        async function loadWeatherData() {
            try {
                const response = await fetch(`/api/v1/monitoring/weather?t=${Date.now()}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Cache-Control': 'no-cache'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data) {
                        updateWeatherDisplay(data.data);
                    }
                } else {
                    console.error('Failed to load weather data:', response.status);
                }
            } catch (error) {
                console.error('Error loading weather data:', error);
            }
        }

        function updateWeatherDisplay(data) {
            // Update latest blurb
            if (data.latestBlurb) {
                document.getElementById('currentWeatherBlurb').innerHTML = `
                    <p class="text-gray-700 leading-relaxed">
                        <span class="text-2xl mr-2">${data.latestBlurb.icon}</span>
                        ${data.latestBlurb.text}
                    </p>
                `;
                document.getElementById('weatherTemp').textContent = data.latestBlurb.temperature ? `${data.latestBlurb.temperature}¬∞C` : '-';
                document.getElementById('weatherConditions').textContent = data.latestBlurb.conditions || '-';
                document.getElementById('weatherWind').textContent =
                    data.latestBlurb.windSpeed ? `${data.latestBlurb.windSpeed} m/s ${data.latestBlurb.windDirection || ''}` : '-';
                document.getElementById('weatherCreated').textContent =
                    data.latestBlurb.createdAt ? new Date(data.latestBlurb.createdAt).toLocaleString('et-EE') : '-';
            } else {
                document.getElementById('currentWeatherBlurb').innerHTML = `
                    <p class="text-gray-500">Ilmateadet pole veel genereeritud</p>
                `;
            }

            // Update statistics
            if (data.statistics) {
                document.getElementById('weatherTotalBlurbs').textContent = data.statistics.totalBlurbs || 0;
                document.getElementById('weatherRecentBlurbs').textContent = data.statistics.recentBlurbs || 0;
                document.getElementById('weatherAvgTemp').textContent =
                    data.statistics.avgTemperature ? `${data.statistics.avgTemperature.toFixed(1)}¬∞C` : '-';
            }

            // Update next update time
            if (data.nextUpdate) {
                document.getElementById('weatherNextUpdate').textContent = data.nextUpdate.display || '-';
            }

            // Update config
            if (data.config) {
                document.getElementById('weatherModel').textContent =
                    data.config.openAiConfigured ? data.config.model : 'Pole konfigureeritud';
            }

            // Update history table
            if (data.blurbHistory && data.blurbHistory.length > 0) {
                const tbody = document.getElementById('weatherHistoryTable');
                const noHistory = document.getElementById('noWeatherHistory');

                noHistory.classList.add('hidden');
                tbody.innerHTML = data.blurbHistory.map(blurb => `
                    <tr>
                        <td class="px-4 py-2 text-sm whitespace-nowrap">
                            ${new Date(blurb.createdAt).toLocaleString('et-EE', {
                                day: '2-digit',
                                month: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            })}
                        </td>
                        <td class="px-4 py-2 text-sm">
                            <span class="mr-1">${blurb.icon}</span>
                            ${blurb.text.length > 100 ? blurb.text.substring(0, 100) + '...' : blurb.text}
                        </td>
                        <td class="px-4 py-2 text-sm text-center">
                            ${blurb.temperature ? `${blurb.temperature}¬∞C` : '-'}
                        </td>
                        <td class="px-4 py-2 text-sm">
                            ${blurb.conditions || '-'}
                        </td>
                    </tr>
                `).join('');
            } else {
                document.getElementById('weatherHistoryTable').innerHTML = '';
                document.getElementById('noWeatherHistory').classList.remove('hidden');
            }
        }

        async function generateWeatherBlurb() {
            if (!confirm('Kas soovid genereerida uue ilmateate?')) {
                return;
            }

            const button = event.target;
            button.disabled = true;
            button.textContent = 'Genereerimine...';

            try {
                const response = await fetch('/api/v1/weather/generate', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    alert('Uus ilmateade genereeritud!');
                    await loadWeatherData();
                } else {
                    alert('Viga: ' + (data.error || 'Teate genereerimine eba√µnnestus'));
                }
            } catch (error) {
                console.error('Error generating weather blurb:', error);
                alert('Viga teate genereerimisel');
            } finally {
                button.disabled = false;
                button.textContent = 'Genereeri uus teade';
            }
        }

        function logout() {
            localStorage.removeItem('adminToken');
            document.cookie = 'adminToken=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT';
            window.location.href = '/admin/login';
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        // Load data on page load
        loadMonitoringData();

        // Auto-refresh every 30 seconds
        setInterval(loadMonitoringData, 30000);
    </script>
</body>
</html>