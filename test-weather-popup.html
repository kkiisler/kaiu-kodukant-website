<!DOCTYPE html>
<html lang="et">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Popup Test - Kaiu Kodukant</title>
    <meta name="description" content="Weather popup test page">

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Configure Tailwind with custom colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'silk': '#F3F0EA',
                        'sirocco': '#68766E',
                        'apricot': '#E8A760',
                        'cinnamon': '#EC5B29',
                        'brick': '#D26911',
                        'cascades': '#273E3E',
                        'cascades-dark': '#1a2929',
                    },
                    maxWidth: {
                        'wide': '1280px',
                    }
                }
            }
        }
    </script>

    <!-- Custom styles -->
    <link rel="stylesheet" href="/css/styles.css">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', system-ui, sans-serif;
        }
        .test-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
    </style>
</head>
<body class="bg-silk">
    <!-- Header placeholder -->
    <div id="header-placeholder"></div>

    <!-- Test Content -->
    <main class="min-h-screen py-12">
        <div class="max-w-wide mx-auto px-6">
            <h1 class="text-4xl font-bold text-cascades mb-8">Weather Popup Test</h1>

            <div class="grid md:grid-cols-2 gap-8">
                <!-- Controls -->
                <div class="test-section p-6 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-semibold text-cascades mb-4">Test Controls</h2>

                    <div class="space-y-4">
                        <button id="test-show" class="px-4 py-2 bg-cinnamon text-white rounded-lg hover:bg-brick transition-colors w-full">
                            Show Weather Popup
                        </button>

                        <button id="test-hide" class="px-4 py-2 bg-sirocco text-white rounded-lg hover:bg-cascades transition-colors w-full">
                            Hide Weather Popup
                        </button>

                        <button id="test-toggle" class="px-4 py-2 bg-apricot text-cascades rounded-lg hover:bg-brick hover:text-white transition-colors w-full">
                            Toggle Weather Popup
                        </button>

                        <button id="test-fetch" class="px-4 py-2 bg-cascades text-white rounded-lg hover:bg-cascades-dark transition-colors w-full">
                            Fetch Fresh Weather Data
                        </button>

                        <button id="test-clear-storage" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors w-full">
                            Clear Local Storage
                        </button>
                    </div>
                </div>

                <!-- Status Display -->
                <div class="test-section p-6 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-semibold text-cascades mb-4">Status</h2>

                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="font-medium">Popup Status:</span>
                            <span id="status-visible" class="text-sirocco">Not loaded</span>
                        </div>

                        <div class="flex justify-between">
                            <span class="font-medium">Last Fetch:</span>
                            <span id="status-fetch" class="text-sirocco">Never</span>
                        </div>

                        <div class="flex justify-between">
                            <span class="font-medium">Temperature:</span>
                            <span id="status-temp" class="text-sirocco">--°C</span>
                        </div>

                        <div class="flex justify-between">
                            <span class="font-medium">Conditions:</span>
                            <span id="status-conditions" class="text-sirocco">--</span>
                        </div>

                        <div class="flex justify-between">
                            <span class="font-medium">Weather Icon:</span>
                            <span id="status-icon" class="text-2xl">--</span>
                        </div>
                    </div>

                    <div class="mt-4 pt-4 border-t border-gray-300">
                        <h3 class="font-medium mb-2">Latest Blurb:</h3>
                        <p id="status-blurb" class="text-sm text-sirocco italic">No blurb loaded</p>
                    </div>
                </div>
            </div>

            <!-- Console Output -->
            <div class="mt-8 test-section p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold text-cascades mb-4">Console Output</h2>
                <div id="console-output" class="bg-gray-900 text-green-400 p-4 rounded font-mono text-sm h-64 overflow-y-auto">
                    <div>Weather Popup Test Page Ready...</div>
                </div>
            </div>

            <!-- API Test -->
            <div class="mt-8 test-section p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold text-cascades mb-4">Direct API Test</h2>
                <button id="test-api" class="px-4 py-2 bg-cinnamon text-white rounded-lg hover:bg-brick transition-colors mb-4">
                    Test Weather API
                </button>
                <pre id="api-response" class="bg-gray-900 text-green-400 p-4 rounded text-xs overflow-x-auto">
                    API response will appear here...
                </pre>
            </div>
        </div>
    </main>

    <!-- Footer placeholder -->
    <div id="footer-placeholder"></div>

    <!-- Scripts -->
    <script src="/js/config.js"></script>
    <script src="/js/common.js"></script>

    <script>
        // Console logger
        function log(message, type = 'info') {
            const consoleEl = document.getElementById('console-output');
            const timestamp = new Date().toLocaleTimeString('et-EE');
            const colors = {
                info: 'text-green-400',
                error: 'text-red-400',
                warning: 'text-yellow-400'
            };

            const div = document.createElement('div');
            div.className = colors[type] || 'text-green-400';
            div.textContent = `[${timestamp}] ${message}`;
            consoleEl.appendChild(div);
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        // Wait for weather popup to be initialized
        function waitForWeatherPopup(callback) {
            if (window.weatherPopup) {
                callback();
            } else {
                setTimeout(() => waitForWeatherPopup(callback), 100);
            }
        }

        // Update status display
        function updateStatus() {
            if (!window.weatherPopup) {
                document.getElementById('status-visible').textContent = 'Not loaded';
                return;
            }

            document.getElementById('status-visible').textContent =
                window.weatherPopup.isVisible ? 'Visible' : 'Hidden';

            if (window.weatherPopup.weatherData) {
                const data = window.weatherPopup.weatherData;
                document.getElementById('status-temp').textContent =
                    data.temperature ? `${Math.round(data.temperature)}°C` : '--°C';
                document.getElementById('status-conditions').textContent =
                    data.conditions || '--';
                document.getElementById('status-blurb').textContent =
                    data.blurb || 'No blurb';
                document.getElementById('status-icon').textContent =
                    window.weatherPopup.getWeatherEmoji(data.icon || data.conditions);
            }

            if (window.weatherPopup.lastFetch) {
                const date = new Date(window.weatherPopup.lastFetch);
                document.getElementById('status-fetch').textContent =
                    date.toLocaleTimeString('et-EE');
            }
        }

        // Setup test controls
        document.addEventListener('DOMContentLoaded', function() {
            log('Test page initialized');

            waitForWeatherPopup(() => {
                log('Weather popup loaded successfully');
                updateStatus();

                // Show button
                document.getElementById('test-show').addEventListener('click', async () => {
                    log('Showing weather popup...');
                    await window.weatherPopup.show();
                    updateStatus();
                    log('Weather popup shown');
                });

                // Hide button
                document.getElementById('test-hide').addEventListener('click', () => {
                    log('Hiding weather popup...');
                    window.weatherPopup.hide();
                    updateStatus();
                    log('Weather popup hidden');
                });

                // Toggle button
                document.getElementById('test-toggle').addEventListener('click', () => {
                    log('Toggling weather popup...');
                    window.weatherPopup.toggle();
                    updateStatus();
                    log(`Weather popup ${window.weatherPopup.isVisible ? 'shown' : 'hidden'}`);
                });

                // Fetch button
                document.getElementById('test-fetch').addEventListener('click', async () => {
                    log('Fetching fresh weather data...');
                    const data = await window.weatherPopup.fetchWeatherData();
                    if (data) {
                        log('Weather data fetched successfully');
                        updateStatus();
                    } else {
                        log('Failed to fetch weather data', 'error');
                    }
                });

                // Clear storage
                document.getElementById('test-clear-storage').addEventListener('click', () => {
                    log('Clearing local storage...', 'warning');
                    const keys = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key.startsWith('weather_')) {
                            keys.push(key);
                        }
                    }
                    keys.forEach(key => localStorage.removeItem(key));
                    log(`Cleared ${keys.length} weather-related items from local storage`);
                    updateStatus();
                });
            });

            // Direct API test
            document.getElementById('test-api').addEventListener('click', async () => {
                log('Testing direct API call...');
                try {
                    const response = await fetch('https://api.kaiukodukant.ee/api/v1/weather/current');
                    const data = await response.json();
                    document.getElementById('api-response').textContent =
                        JSON.stringify(data, null, 2);
                    log('API call successful');
                } catch (error) {
                    document.getElementById('api-response').textContent =
                        `Error: ${error.message}`;
                    log(`API call failed: ${error.message}`, 'error');
                }
            });

            // Monitor popup state changes
            setInterval(updateStatus, 1000);
        });
    </script>
</body>
</html>