<!DOCTYPE html>
<html lang="et">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Calendar Description Formatting</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .test-case {
            border: 2px solid #ddd;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0.5rem;
        }
        .raw {
            background: #f5f5f5;
            padding: 0.5rem;
            margin: 0.5rem 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .formatted {
            background: #fff;
            padding: 0.5rem;
            margin: 0.5rem 0;
            border: 1px solid #e0e0e0;
        }
    </style>
</head>
<body class="p-8 bg-gray-50">
    <h1 class="text-2xl font-bold mb-6">Calendar Description Formatting Test</h1>

    <div id="test-container"></div>

    <script>
        // Copy the formatting function from calendar.js
        function formatEventDescription(description) {
            if (!description) {
                return '<p>Täpsem kirjeldus puudub.</p>';
            }

            // First, escape HTML to prevent XSS attacks
            const escapeHtml = (text) => {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            };

            // Escape the description
            let formatted = escapeHtml(description);

            // Convert URLs to clickable links
            // Matches http://, https://, and www. URLs
            const urlRegex = /((https?:\/\/(www\.)?|www\.)[^\s<]+)/gi;
            formatted = formatted.replace(urlRegex, (match) => {
                let url = match;
                // Add protocol if missing
                if (!url.match(/^https?:\/\//)) {
                    url = 'https://' + url;
                }
                return `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 underline">${match}</a>`;
            });

            // Convert email addresses to mailto links
            const emailRegex = /([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9._-]+)/gi;
            formatted = formatted.replace(emailRegex, '<a href="mailto:$1" class="text-blue-600 hover:text-blue-800 underline">$1</a>');

            // Convert newlines to <br> tags for proper line breaks
            formatted = formatted.replace(/\n/g, '<br>');

            // Convert double line breaks to paragraphs for better spacing
            formatted = formatted.replace(/(<br>){2,}/g, '</p><p class="mt-3">');

            // Wrap in paragraph tags if not already
            if (!formatted.startsWith('<p')) {
                formatted = '<p>' + formatted + '</p>';
            }

            // Handle basic markdown-style formatting (optional but useful)
            // Bold: **text** or __text__
            formatted = formatted.replace(/\*\*(.+?)\*\*|__(.+?)__/g, '<strong>$1$2</strong>');

            // Italic: *text* or _text_ (but not part of URLs)
            formatted = formatted.replace(/(?<!https?:\/\/[^\s]*)\*([^\*]+)\*|(?<!https?:\/\/[^\s]*)_([^_]+)_/g, '<em>$1$2</em>');

            // Lists: lines starting with - or *
            formatted = formatted.replace(/<br>[\-\*]\s+(.+?)(?=<br>|<\/p>|$)/g, '<br>• $1');

            return formatted;
        }

        // Test cases
        const testCases = [
            {
                name: "Simple text with line breaks",
                description: "Tere tulemast üritusele!\nKohtume kell 18:00.\nÄrge unustage kaasa võtta:\n- Head tuju\n- Midagi suupisteks"
            },
            {
                name: "Text with URLs",
                description: "Registreerimine: https://forms.google.com/register\n\nRohkem infot: www.kaiukodukant.ee\n\nKirjutage meile: info@kaiukodukant.ee"
            },
            {
                name: "Text with markdown formatting",
                description: "**Tähtis teade!**\n\nÜritus toimub _ilmast sõltumata_.\n\n**Päevakava:**\n- 10:00 Avamine\n- 11:00 Töötoad\n- 13:00 Lõuna\n- 14:00 Kontsert"
            },
            {
                name: "Complex formatted text",
                description: "**Kevadine talgupäev 2025**\n\nTere tulemast traditsioonilisele kevadisele talgupäevale!\n\nAeg: 25. aprill kell 10:00-15:00\nKoht: Kaiu keskväljak\n\n**Kavas:**\n- Küla koristamine\n- Mänguväljaku korrastamine  \n- Lillede istutamine\n- Ühine lõunasöök\n\n**Kaasa võtta:**\n- Töökindad\n- Hea tuju\n- Tööriistaid (kui on)\n\nRegistreerimine: https://forms.gle/abc123\nKüsimused: talgu@kaiukodukant.ee\n\nLisainfo: www.kaiukodukant.ee/talgud"
            },
            {
                name: "Text with HTML injection attempt (security test)",
                description: "<script>alert('XSS')</script>\n<b>Bold text</b>\n<a href=\"javascript:alert('XSS')\">Malicious link</a>"
            }
        ];

        // Render test cases
        const container = document.getElementById('test-container');
        testCases.forEach((testCase, index) => {
            const div = document.createElement('div');
            div.className = 'test-case';
            div.innerHTML = `
                <h2 class="text-lg font-bold mb-2">Test ${index + 1}: ${testCase.name}</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h3 class="font-semibold text-sm text-gray-600">Raw (from JSON):</h3>
                        <div class="raw">${testCase.description}</div>
                    </div>
                    <div>
                        <h3 class="font-semibold text-sm text-gray-600">Formatted (on website):</h3>
                        <div class="formatted">${formatEventDescription(testCase.description)}</div>
                    </div>
                </div>
            `;
            container.appendChild(div);
        });
    </script>
</body>
</html>